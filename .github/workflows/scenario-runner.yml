name: Scenario Runner

on:
  push:
    branches:
      - main
    paths:
      - 'scenario.toml'
      - '.github/workflows/scenario-runner.yml'
  workflow_dispatch:
    inputs:
      purple_agent:
        description: 'Which purple agent to run (or "all")'
        required: false
        default: 'all'

jobs:
  run-scenario:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Checkout ArchXGreen repository
        uses: actions/checkout@v3
        with:
          repository: Siddhant-sama/ArchXGreen
          path: ArchXGreen
      
      - name: Build green agent image
        run: |
          cd ArchXGreen
          docker build -t green-agent:latest -f Dockerfile .
      
      - name: Build purple agent image
        run: |
          cd ArchXGreen
          # Create Dockerfile for purple agent using same base
          cat > Dockerfile.purple <<'EOF'
          FROM ghcr.io/astral-sh/uv:python3.13-bookworm
          
          RUN apt-get update \
              && apt-get install -y --no-install-recommends \
                  git \
                  curl \
                  jq \
              && rm -rf /var/lib/apt/lists/*
          
          RUN adduser agent
          USER agent
          WORKDIR /home/agent
          
          COPY pyproject.toml uv.lock README.md ./
          COPY src src
          
          RUN \
              --mount=type=cache,target=/home/agent/.cache/uv,uid=1000 \
              uv sync --locked --extra llm
          
          # Entry point runs purple agent
          ENTRYPOINT ["uv", "run", "src/purple_agent/agent.py"]
          CMD ["--backend", "openrouter", "--levels", "level-0", "--max-iterations", "3"]
          EOF
          
          docker build -t purple-agent:latest -f Dockerfile.purple .
      
      - name: Create results directory
        run: |
          mkdir -p results
          mkdir -p submissions
      
      - name: Start green agent
        id: green_agent
        run: |
          echo "Starting green agent on port 9009..."
          
          docker run -d \
            --name green-agent \
            -p 9009:9009 \
            -e HOST=0.0.0.0 \
            -e PORT=9009 \
            -e USE_DYNAMIC_LOADER=true \
            green-agent:latest
          
          # Wait for startup
          sleep 8
          
          # Health check with retries
          for i in {1..10}; do
            if curl -f http://localhost:9009/health > /dev/null 2>&1; then
              echo "Green agent is healthy"
              break
            fi
            echo "Waiting for green agent... attempt $i"
            sleep 3
          done
          
          # Verify and get task count
          HEALTH=$(curl -s http://localhost:9009/health)
          TASK_COUNT=$(echo "$HEALTH" | jq '.total_tasks')
          echo "Green agent ready with $TASK_COUNT tasks"
          echo "task_count=$TASK_COUNT" >> $GITHUB_OUTPUT
      
      - name: Run purple agent evaluation
        id: evaluation
        run: |
          echo "Running purple agent against green agent..."
          
          # Check if purple agent requires API key
          # Purple agent developers must provide their own API keys as GitHub secrets
          # named: PURPLE_AGENT_API_KEY (or specific keys like OPENROUTER_API_KEY)
          
          # Run purple agent - API key must be baked into image or provided by submitter
          docker run --rm \
            --name purple-agent \
            --network host \
            -e OPENROUTER_API_KEY="${{ secrets.PURPLE_AGENT_API_KEY }}" \
            -e OPENAI_API_KEY="${{ secrets.PURPLE_AGENT_API_KEY }}" \
            -e ANTHROPIC_API_KEY="${{ secrets.PURPLE_AGENT_API_KEY }}" \
            -v $(pwd)/results:/home/agent/results \
            purple-agent:latest \
            --backend openrouter \
            --model anthropic/claude-3.5-sonnet \
            --green-url http://localhost:9009 \
            --levels level-0 \
            --max-iterations 3 \
            --no-llm-validation \
            --output /home/agent/results/evaluation_results.json
          
          echo "Purple agent evaluation complete"
          
          # Extract metrics from results
          if [ -f results/evaluation_results.json ]; then
            PASS_RATE=$(jq -r '.pass_rate' results/evaluation_results.json)
            TASKS_PASSED=$(jq -r '.passed' results/evaluation_results.json)
            TASKS_TOTAL=$(jq -r '.total_tasks' results/evaluation_results.json)
            EXEC_TIME=$(jq -r '.execution_time_sec' results/evaluation_results.json)
            
            echo "pass_rate=$PASS_RATE" >> $GITHUB_OUTPUT
            echo "tasks_passed=$TASKS_PASSED" >> $GITHUB_OUTPUT
            echo "tasks_total=$TASKS_TOTAL" >> $GITHUB_OUTPUT
            echo "exec_time=$EXEC_TIME" >> $GITHUB_OUTPUT
            
            echo "Results: $TASKS_PASSED/$TASKS_TOTAL passed (${PASS_RATE})"
          fi
      
      - name: Post results to AgentBeats webhook
        if: steps.evaluation.outcome == 'success'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Build webhook payload
          cat > webhook_payload.json <<EOF
          {
            "green_agent_id": "019bc5b7-cc56-7f23-95f7-e15e0095acb4",
            "purple_agent_id": "019bc5b3-2114-7553-933a-2c6f5cbb0fa4",
            "submission_id": "${{ github.run_id }}",
            "submission_timestamp": "$TIMESTAMP",
            "github_commit_sha": "${{ github.sha }}",
            "github_actor": "${{ github.actor }}",
            "tasks_evaluated": ${{ steps.evaluation.outputs.tasks_total }},
            "tasks_passed": ${{ steps.evaluation.outputs.tasks_passed }},
            "pass_rate": ${{ steps.evaluation.outputs.pass_rate }},
            "execution_time_sec": ${{ steps.evaluation.outputs.exec_time }},
            "results_file": "results/evaluation_results.json",
            "status": "completed"
          }
          EOF
          
          # Post to AgentBeats webhook
          curl -X POST \
            -H "Content-Type: application/json" \
            -d @webhook_payload.json \
            https://agentbeats.dev/api/hook/v2/019bc5b7-cc5c-7a62-a14f-4e813bdb25e1
          
          echo "Results posted to AgentBeats"
      
      - name: Collect results
        if: steps.evaluation.outcome == 'success'
        id: results
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          RESULT_FILE="results/assessment-${TIMESTAMP}.json"
          
          # Create assessment summary
          cat > "$RESULT_FILE" <<EOF
          {
            "timestamp": "$TIMESTAMP",
            "run_id": "${{ github.run_id }}",
            "commit_sha": "${{ github.sha }}",
            "actor": "${{ github.actor }}",
            "green_agent": {
              "id": "019bc5b7-cc56-7f23-95f7-e15e0095acb4",
              "name": "ArchXGreen Green Agent",
              "image": "ghcr.io/siddhant-sama/archxgreen:latest",
              "total_tasks": ${{ steps.green_agent.outputs.task_count }}
            },
            "purple_agent": {
              "id": "019bc5b3-2114-7553-933a-2c6f5cbb0fa4",
              "name": "ArchXGreen Baseline Purple Agent",
              "image": "ghcr.io/siddhant-sama/archxgreen/purple:latest"
            },
            "results": {
              "tasks_evaluated": ${{ steps.evaluation.outputs.tasks_total }},
              "tasks_passed": ${{ steps.evaluation.outputs.tasks_passed }},
              "pass_rate": ${{ steps.evaluation.outputs.pass_rate }},
              "execution_time_sec": ${{ steps.evaluation.outputs.exec_time }}
            },
            "webhook_posted": true,
            "status": "completed"
          }
          EOF
          
          echo "result_file=$RESULT_FILE" >> $GITHUB_OUTPUT
      
      - name: Generate submission record
        if: steps.results.outcome == 'success'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          SUBMISSION_FILE="submissions/submission-${TIMESTAMP}.json"
          
          cat > "$SUBMISSION_FILE" <<EOF
          {
            "timestamp": "$TIMESTAMP",
            "git_commit": "${{ github.sha }}",
            "git_branch": "${{ github.ref }}",
            "github_run_id": "${{ github.run_id }}",
            "github_actor": "${{ github.actor }}",
            "green_agent_id": "019bc5b7-cc56-7f23-95f7-e15e0095acb4",
            "purple_agent_id": "019bc5b3-2114-7553-933a-2c6f5cbb0fa4",
            "tasks_evaluated": ${{ steps.evaluation.outputs.tasks_total }},
            "tasks_passed": ${{ steps.evaluation.outputs.tasks_passed }},
            "pass_rate": ${{ steps.evaluation.outputs.pass_rate }},
            "result_file": "${{ steps.results.outputs.result_file }}",
            "webhook_posted": true,
            "status": "completed"
          }
          EOF
          
          echo "Submission record created: $SUBMISSION_FILE"
      
      - name: Clean up containers
        if: always()
        run: |
          docker stop green-agent || true
          docker stop purple-agent || true
          docker rm green-agent || true
          docker rm purple-agent || true
      
      - name: Create pull request with results
        if: github.ref == 'refs/heads/main' && steps.results.outcome == 'success'
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "ci: Add assessment results from workflow run ${{ github.run_id }}"
          title: "Assessment Results - Run ${{ github.run_id }}"
          body: |
            # Assessment Results
            
            Automated assessment results from GitHub Actions run.
            
            ## Run Details
            - **Run ID:** ${{ github.run_id }}
            - **Commit:** ${{ github.sha }}
            - **Actor:** ${{ github.actor }}
            - **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            
            ## Results Summary
            - **Tasks Evaluated:** ${{ steps.evaluation.outputs.tasks_total }}
            - **Tasks Passed:** ${{ steps.evaluation.outputs.tasks_passed }}
            - **Pass Rate:** ${{ steps.evaluation.outputs.pass_rate }}%
            - **Execution Time:** ${{ steps.evaluation.outputs.exec_time }}s
            
            ## Agents
            - **Green Agent:** 019bc5b7-cc56-7f23-95f7-e15e0095acb4 (ArchXGreen)
            - **Purple Agent:** 019bc5b3-2114-7553-933a-2c6f5cbb0fa4 (Baseline)
            
            ## Files
            - Results: `results/`
            - Submissions: `submissions/`
            - Evaluation Details: `results/evaluation_results.json`
            
            **Webhook Status:** âœ“ Posted to AgentBeats
            
            ---
            
            Please review and merge to finalize submission on AgentBeats leaderboard.
          branch: assessment-results-${{ github.run_id }}
          delete-branch: true
